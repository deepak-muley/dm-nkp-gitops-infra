apiVersion: v1
kind: ConfigMap
metadata:
  name: project-grafana-loki-overrides
  namespace: dm-dev-project
data:
  values.yaml: |
    ingester:
      replicas: 1
      resources:
        limits:
          memory: 8Gi
          cpu: 2
        requests:
          memory: 4Gi
          cpu: 500m
      extraArgs:
        - -config.expand-env=true

    distributor:
      resources:
        limits:
          memory: 1Gi
          cpu: 1
        requests:
          memory: 512Mi
          cpu: 250m

    querier:
      resources:
        limits:
          memory: 2Gi
          cpu: 1
        requests:
          memory: 1Gi
          cpu: 250m

    queryFrontend:
      resources:
        limits:
          memory: 1Gi
          cpu: 500m
        requests:
          memory: 256Mi
          cpu: 100m

    compactor:
      resources:
        limits:
          memory: 1Gi
          cpu: 500m
        requests:
          memory: 256Mi
          cpu: 100m

    gateway:
      resources:
        limits:
          memory: 256Mi
          cpu: 200m
        requests:
          memory: 128Mi
          cpu: 50m

    # Tighten ingestion limits to prevent memory spikes
    loki:
      limits_config:
        ingestion_rate_mb: 5
        ingestion_burst_size_mb: 8
        per_stream_rate_limit: 5MB
        per_stream_rate_limit_burst: 10MB
        max_streams_per_user: 10000
        max_chunks_per_query: 2000000
        max_entries_limit_per_query: 5000

      ingester:
        chunk_idle_period: 15m
        chunk_retain_period: 30s
        max_chunk_age: 1h

