# Require Host Users Disabled
# MEDIUM: Requires hostUsers: false to enable user namespace isolation
# Reference: Kubernetes user namespaces feature - improves security isolation
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-host-users-false
  annotations:
    policies.kyverno.io/title: Require Host Users Disabled
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    kyverno.io/kyverno-version: 1.6.0+
    kyverno.io/kubernetes-version: "1.25-1.30"
    policies.kyverno.io/description: >-
      User namespaces provide additional isolation by mapping container UIDs/GIDs
      to different UIDs/GIDs on the host. Setting hostUsers: false enables this
      security feature. This prevents various attacks that rely on UID/GID collisions
      and improves container isolation from the host system.
      Note: Requires Kubernetes 1.25+ and user namespace support in the container runtime.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: require-host-users-false
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - capi-system
                - capi-kubeadm-bootstrap-system
                - capi-kubeadm-control-plane-system
                - capa-system
                - capz-system
                - capg-system
                - capv-system
                - caaph-system
                - capk-system
                - capd-system
      validate:
        message: >-
          Pods should set hostUsers: false to enable user namespace isolation.
          This improves security by preventing UID/GID collisions with the host system.
        pattern:
          spec:
            securityContext:
              hostUsers: false

