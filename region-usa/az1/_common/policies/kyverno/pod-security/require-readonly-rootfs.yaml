# Require Read-Only Root Filesystem
# Reference: https://kyverno.io/policies/best-practices/require-read-only-root-filesystem/
# MEDIUM: Prevents modification of container filesystem
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: require-readonly-root-filesystem
  annotations:
    policies.kyverno.io/title: Require Read-Only Root Filesystem
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Pod
    kyverno.io/kyverno-version: 1.6.0+
    kyverno.io/kubernetes-version: "1.22-1.30"
    policies.kyverno.io/description: >-
      A read-only root filesystem prevents applications from writing to the
      container filesystem. This is a security best practice that:
      - Prevents attackers from modifying binaries
      - Blocks persistence mechanisms
      - Forces applications to use volumes for state
      This policy validates that containers have readOnlyRootFilesystem set to true.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: validate-readonly-root-filesystem
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - capi-system
                - capi-kubeadm-bootstrap-system
                - capi-kubeadm-control-plane-system
                - capa-system
                - capz-system
                - capg-system
                - capv-system
                - caaph-system
                - capk-system
                - capd-system
      validate:
        message: >-
          Read-only root filesystem is required. Set spec.containers[*].securityContext.readOnlyRootFilesystem
          to true. Use emptyDir or other volumes for any directories that require write access.
        pattern:
          spec:
            containers:
              - securityContext:
                  readOnlyRootFilesystem: true
            =(initContainers):
              - securityContext:
                  readOnlyRootFilesystem: true
            =(ephemeralContainers):
              - securityContext:
                  readOnlyRootFilesystem: true

