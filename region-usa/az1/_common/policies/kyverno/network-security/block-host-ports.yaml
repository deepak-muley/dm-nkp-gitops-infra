# Block Host Ports
# Reference: https://kyverno.io/policies/pod-security/baseline/disallow-host-ports/
# HIGH: Prevents containers from binding to host ports
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-host-ports
  annotations:
    policies.kyverno.io/title: Disallow Host Ports
    policies.kyverno.io/category: Pod Security Standards (Baseline)
    policies.kyverno.io/severity: high
    policies.kyverno.io/subject: Pod
    kyverno.io/kyverno-version: 1.6.0+
    kyverno.io/kubernetes-version: "1.22-1.30"
    policies.kyverno.io/description: >-
      Access to host ports allows potential snooping of network traffic and
      bypasses network policies. This policy ensures pods do not use hostPort.
      If specific host ports are needed (e.g., for an ingress controller), use
      excludedNamespaces.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: host-ports-none
      match:
        any:
          - resources:
              kinds:
                - Pod
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - capi-system
                - capi-kubeadm-bootstrap-system
                - capi-kubeadm-control-plane-system
                - capa-system
                - capz-system
                - capg-system
                - capv-system
                - caaph-system
                - capk-system
                - capd-system
                # Ingress controllers may need host ports
                - traefik
                - traefik-system
                - ingress-nginx
      validate:
        message: >-
          Use of host ports is not allowed. The field spec.containers[*].ports[*].hostPort
          and spec.initContainers[*].ports[*].hostPort must be unset or 0.
        pattern:
          spec:
            =(initContainers):
              - =(ports):
                  - =(hostPort): 0
            containers:
              - =(ports):
                  - =(hostPort): 0
            =(ephemeralContainers):
              - =(ports):
                  - =(hostPort): 0

