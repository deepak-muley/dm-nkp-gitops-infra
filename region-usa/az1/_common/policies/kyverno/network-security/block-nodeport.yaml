# Block NodePort Services
# Reference: https://kyverno.io/policies/best-practices/restrict-service-types/
# MEDIUM: Prevents direct node port exposure
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: disallow-nodeport-services
  annotations:
    policies.kyverno.io/title: Disallow NodePort Services
    policies.kyverno.io/category: Best Practices
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: Service
    kyverno.io/kyverno-version: 1.6.0+
    kyverno.io/kubernetes-version: "1.22-1.30"
    policies.kyverno.io/description: >-
      NodePort services expose applications on each node's IP at a static port.
      This creates security and management concerns:
      - Bypasses ingress controller routing and policies
      - Requires firewall rules on every node
      - Makes services harder to manage and secure
      Use ClusterIP with an Ingress controller instead.
spec:
  validationFailureAction: Audit
  background: true
  rules:
    - name: disallow-nodeport
      match:
        any:
          - resources:
              kinds:
                - Service
      exclude:
        any:
          - resources:
              namespaces:
                - kube-system
                - kube-public
                - kube-node-lease
                - capi-system
                - capi-kubeadm-bootstrap-system
                - capi-kubeadm-control-plane-system
                - capa-system
                - capz-system
                - capg-system
                - capv-system
                - caaph-system
                - capk-system
                - capd-system
                - traefik
                - traefik-system
      validate:
        message: >-
          NodePort services are not allowed. Use ClusterIP with an Ingress controller
          for external access. If NodePort is required, request an exception.
        pattern:
          spec:
            type: "!NodePort"

