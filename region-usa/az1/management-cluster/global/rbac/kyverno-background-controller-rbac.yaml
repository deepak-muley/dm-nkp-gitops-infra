# =============================================================================
# Kyverno Background Controller RBAC
# =============================================================================
#
# PURPOSE:
#   Grants the Kyverno background controller service account permissions to
#   create, update, and delete resources generated by Kyverno generate rules.
#
# CONTEXT:
#   When Kyverno policies use "generate" rules (e.g., to auto-create
#   PodDisruptionBudgets), the kyverno-background-controller service account
#   needs explicit RBAC permissions to perform these operations.
#
# REFERENCE:
#   https://kyverno.io/docs/writing-policies/generate/
#   https://kyverno.io/docs/installation/#rbac-for-generate-rules
#
# =============================================================================
---
# ClusterRole: Grants permissions to create/update/delete generated resources
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: kyverno-background-controller-generate
  annotations:
    description: "Grants Kyverno background controller permissions to manage generated resources (PDBs, NetworkPolicies, etc.)"
rules:
  # PodDisruptionBudget permissions (for require-pdb-for-ha-deployments policy)
  - apiGroups:
      - policy
    resources:
      - poddisruptionbudgets
    verbs:
      - create
      - update
      - delete
      - get
      - list
      - watch
  # NetworkPolicy permissions (for future network policy generation)
  - apiGroups:
      - networking.k8s.io
    resources:
      - networkpolicies
    verbs:
      - create
      - update
      - delete
      - get
      - list
      - watch
  # ConfigMap permissions (for future config generation)
  - apiGroups:
      - ""
    resources:
      - configmaps
    verbs:
      - create
      - update
      - delete
      - get
      - list
      - watch
  # Secret permissions (for future secret generation)
  - apiGroups:
      - ""
    resources:
      - secrets
    verbs:
      - create
      - update
      - delete
      - get
      - list
      - watch
---
# ClusterRoleBinding: Binds the service account to the ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: kyverno-background-controller-generate
  annotations:
    description: "Binds kyverno-background-controller service account to generate resources ClusterRole"
subjects:
  - kind: ServiceAccount
    name: kyverno-background-controller
    namespace: kyverno
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: kyverno-background-controller-generate

